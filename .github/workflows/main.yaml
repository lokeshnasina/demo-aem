name: Build
on:
  workflow_dispatch:
    inputs:
      repoName:
        description: 'Repo name'
        required: true
        default: 'demo_project'

jobs:
  createRepoWithNameParam:
    runs-on: ubuntu-latest
    steps:
      - name: create new repo      
        run: |
          echo ${{ secrets.GH_TOKEN }} > secret.file &&
          gh auth login --with-token < secret.file &&
          gh auth status &&
          gh repo create ${{ github.event.inputs.repoName }} --private --template hlxsites/aem-boilerplate-commerce 
      - name: Sleep for 10s to wait for the repo to be created
        run: sleep 10s 
      - name: clone new repo, change gDocPath and push
        run: |
          mkdir -p ~/.ssh  # Create .ssh directory if it doesn't exist
          ssh-keygen -t ed25519 -C "my description" -N "" -f ~/.ssh/github_rsa
          chmod 600 ~/.ssh/github_rsa.pub
          ls -l ~/.ssh  # List contents of the .ssh directory
          echo "Host github.com" > ~/.ssh/config
          echo "  IdentityFile ~/.ssh/github_rsa" >> ~/.ssh/config
          echo ${{ secrets.GH_TOKEN }} > secret.file &&
          gh auth login --with-token < secret.file &&
          gh auth status &&
          gh repo clone lokeshnasina/${{ github.event.inputs.repoName }} &&
          cd ${{ github.event.inputs.repoName }}
          gh repo deploy-key add ~/.ssh/github_rsa.pub
          sed -i '2s#.*#  / : ${{ github.event.inputs.gdocPath }}#g' fstab.yaml && 
          cat fstab.yaml 
          git config --global user.name "lokeshnasina"
          git remote add origin_2 git@github.com:lokeshnasina/${{ github.event.inputs.repoName }}.git
          eval $(ssh-agent)
          ssh-add ~/.ssh/github_rsa
          git commit -am "use fstab!" 
          git push         